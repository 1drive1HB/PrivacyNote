# PrivacyNote - Codebase Documentation

## Project Overview
**PrivacyNote** is a secure, self-destructing note sharing application with end-to-end encryption. Built with vanilla JavaScript, it features client-side AES-256 encryption, configurable expiration times, and integration with Supabase for storage and Cloudflare Turnstile for bot protection.

**Live Demo:** https://1drive1hb.github.io/PrivacyNote/

---

## Architecture Overview

### Technology Stack
- **Frontend:** Vanilla JavaScript (ES6 modules), HTML5, CSS3
- **Backend/Storage:** Supabase (PostgreSQL)
- **Security:** 
  - AES-256-GCM encryption (Web Crypto API)
  - XOR obfuscation for config in production
  - Cloudflare Turnstile (bot protection)
- **Deployment:** GitHub Pages via GitHub Actions

### Key Security Features
1. **Client-side encryption** - All encryption happens in the browser (AES-256-GCM)
2. **Self-destructing notes** - Automatic deletion after first read
3. **Input validation & sanitization** - `InputSanitizer` utility prevents injection attacks
4. **Rate limiting** - Client-side protection against abuse (5 notes/minute)
5. **Config obfuscation** - XOR encryption for production secrets
6. **CSP headers** - Content Security Policy for XSS protection
7. **UUID validation** - Prevents SQL injection on note retrieval
8. **Database constraints** - Content length (15KB) and read count (0-1) limits
9. **XSS protection** - Uses `textContent` instead of `innerHTML` for user content
10. **Pattern detection** - Blocks suspicious HTML/JavaScript in note content

---

## Directory Structure

```
MAT_PrivN_Project/
├── .github/workflows/          # CI/CD automation
│   └── static.yml              # GitHub Pages deployment + config encryption
├── src/
│   ├── css/                    # Stylesheets
│   │   ├── base.css           # Base styles, variables, layout
│   │   ├── components.css     # Button, form, link components
│   │   ├── note.css           # Note viewing page styles
│   │   ├── settings.css       # Settings accordion styles
│   │   └── styles.css         # Main CSS (imports others)
│   ├── html/
│   │   └── settings.html      # Settings accordion HTML (loaded dynamically)
│   └── js/
│       ├── conf/               # Configuration files (centralized)
│       │   ├── build-config.js     # Node.js script to generate encrypted config
│       │   └── config.js           # Runtime config (dev + prod unified)
│       ├── actions/            # Business logic
│       │   ├── cryptoActions.js    # AES-256 encryption/decryption
│       │   ├── noteQuery.js        # Supabase CRUD operations
│       │   ├── oldCry.js           # Legacy crypto (kept for reference)
│       │   └── settingsUI.js       # Settings UI controller
│       ├── services/           # Core services
│       │   ├── dom.service.js      # DOM manipulation utilities
│       │   ├── note.service.js     # Note creation/viewing orchestration
│       │   ├── supabase.js         # Supabase client initialization
│       │   ├── turnstile.js        # Cloudflare Turnstile integration
│       │   └── whatsappUI.js       # WhatsApp sharing feature
│       ├── utils/
│       │   └── rateLimiter.js      # Client-side rate limiting
│       ├── load-Env.js         # Development environment loader
│       └── main.js             # Application entry point
├── index.html                  # Main page (note creation)
├── note.html                   # Note viewing page
├── .gitignore                  # Git ignore rules (includes .rovodev/)
└── README.md                   # Project readme
```

---

## File-by-File Documentation

### Configuration Files

#### `src/js/conf/config.js`
**Purpose:** Unified runtime configuration (handles both dev and prod modes)

**Features:**
- **Development mode:** Loads from `env.json` via `load-Env.js` → `window.__ENV`
- **Production mode:** Uses XOR-encrypted values (generated by GitHub Actions)
- **Closure pattern:** Hides sensitive data from console inspection
- **URL hash support:** Allows encryption key override via `#key=xxx`
- **Auto-detection:** Checks for `XOR_KEY` constant to determine build mode

**Key Functions:**
- `createSecureConfig()` - Creates closure-protected config object
- `initializeConfig()` - Async initialization, detects dev/prod mode automatically
- `config` - Frozen config object with getters
- `xorDecrypt()` - Decrypts production values

**Security Notes:**
- Deletes `window.__ENV` after initialization (dev mode)
- All config properties are read-only (frozen object)
- Private variables inaccessible from console
- Each production build has unique XOR key

#### `src/js/conf/build-config.js`
**Purpose:** Node.js build script for production config generation

**Used by:** GitHub Actions workflow (`.github/workflows/static.yml`)

**Process:**
1. Reads environment variables (GitHub Secrets)
2. Generates unique XOR key per build
3. Encrypts all config values with XOR + Base64
4. Writes production-ready `src/js/conf/config.js` (overwrites dev version)

**Output:** Complete production config file with encrypted values and decryption logic

**Security:** Each deployment gets unique encryption key, making old builds obsolete

#### `src/js/load-Env.js`
**Purpose:** Development environment loader

**Behavior:**
- **Production:** No-op (config built-in via GitHub Actions)
- **Development:** Loads `env.json` into `window.__ENV`
- Auto-detects environment via hostname check (`github.io` = production)
- Runs on `DOMContentLoaded` before config initialization

**Required `env.json` structure:**
```json
{
  "SUPABASE_URL": "https://xxx.supabase.co",
  "SUPABASE_KEY": "eyJxxx...",
  "SUPABASE_TABLE_M": "notes",
  "CF_TR": "cloudflare_turnstile_key",
  "CF_SECRET_KEY": "secret",
  "ENCRYPTION_KEY": "your-secret-key"
}
```

**Note:** `env.json` must be in project root (ignored by git)

---

### Core Application Files

#### `src/js/main.js`
**Purpose:** Main application entry point and orchestrator

**Class:** `PrivacyNoteApp`

**Initialization Flow:**
1. `initializeElements()` - Cache DOM references
2. `initializeSettings()` - Load settings accordion
3. `initializeServices()` - Init WhatsApp + Turnstile
4. `setupEventListeners()` - Bind UI events
5. `loadDraftNote()` - Restore localStorage draft

**Key Methods:**
- `handleCreateNote()` - Note creation workflow
- `autoSaveNote()` - Draft persistence
- `handleClear()` - Reset form

**Security:**
- Rate limit cleanup on init
- Settings HTML validation (no script tags)

---

### Services Layer

#### `src/js/services/note.service.js`
**Purpose:** High-level note operations orchestration

**Key Methods:**
- `createNote(content, settings)` - Create encrypted note
- `viewNote()` - Retrieve and decrypt note (used in `note.html`)
- `displayNoteLink(url, elements)` - Show generated link with copy functionality

**Features:**
- Turnstile token validation
- Rate limiting integration
- Error handling with user feedback

#### `src/js/services/supabase.js`
**Purpose:** Supabase client singleton

**Exports:**
- `getSupabaseClient()` - Returns initialized client

**Configuration:**
- Disables session persistence
- Uses public schema
- Lazy initialization pattern

#### `src/js/services/dom.service.js`
**Purpose:** DOM manipulation utilities (stateless)

**Static Methods:**
- `getElement(id)` - Safe element retrieval
- `toggleButtonState()` - Loading states
- `showFeedback()` - Toast notifications
- `copyToClipboard()` - Async clipboard API
- `updateCharacterCounter()` - Character count display

#### `src/js/services/turnstile.js`
**Purpose:** Cloudflare Turnstile integration

**Features:**
- Dynamic script loading
- Token generation/validation
- Auto-retry on failure
- Mobile-friendly widget

**Key Methods:**
- `init()` - Render widget
- `getToken()` - Get validation token
- `reset()` - Reset widget after use

#### `src/js/services/whatsappUI.js`
**Purpose:** WhatsApp sharing functionality

**Features:**
- Device detection (mobile vs desktop)
- Auto-formats share message
- Fallback URL handling

---

### Actions Layer

#### `src/js/actions/cryptoActions.js`
**Purpose:** Client-side AES-256-GCM encryption

**Algorithm Details:**
- **Key Derivation:** PBKDF2 (100,000 iterations)
- **Encryption:** AES-GCM-256
- **Salt:** Static `'secure-note-salt'`
- **IV:** Random 12 bytes per encryption

**Functions:**
- `encryptData(text, useEncryption)` - Encrypt or return plain
- `decryptData(encrypted, useEncryption)` - Decrypt with fallback

**Security Notes:**
- Uses Web Crypto API (FIPS compliant)
- Key padding to 32 bytes
- Graceful fallback on failure

#### `src/js/actions/noteQuery.js`
**Purpose:** Supabase database operations

**Functions:**
- `createNote(content, expiresIn, isEncrypted)` - Insert note
- `getNote(id)` - Retrieve and mark as read

**Database Schema (notes table):**
```sql
- id: UUID (primary key)
- content: TEXT (max 15KB via CHECK constraint)
- is_encrypted: BOOLEAN
- expires_in_24h: BOOLEAN
- expires_in_48h: BOOLEAN
- read_count: INTEGER (0 or 1 only via CHECK constraint)
- created_at: TIMESTAMP
- expires_at: TIMESTAMP
```

**Security:**
- Rate limiting (5 notes/minute client-side)
- UUID validation (prevents injection)
- Content length constraint (15KB database limit)
- Read count constraint (0-1 only)
- Atomic read-count increment
- Expiration validation

#### `src/js/actions/settingsUI.js`
**Purpose:** Settings accordion controller

**Features:**
- Dynamic HTML loading from `src/html/settings.html`
- Accordion open/close animation
- Radio button state management
- Default settings (encryption ON, 24h expiration)

**Methods:**
- `loadSettings()` - Fetch HTML
- `initialize()` - Setup UI
- `getCurrentSettings()` - Get form values
- `resetSettings()` - Restore defaults

---

### Utilities

#### `src/js/utils/inputSanitizer.js`
**Purpose:** Input validation and sanitization for security

**Key Methods:**
- `sanitizeText(input)` - Remove null bytes, normalize unicode
- `validateNoteContent(content)` - Comprehensive content validation
- `validateUUID(uuid)` - UUID format validation
- `escapeHTML(text)` - Prevent XSS attacks
- `detectSuspiciousPattern(content)` - Detect malicious patterns

**Validation Rules:**
- Max length: 10,000 characters
- No null bytes (\0)
- Control character limit: <10% of content
- Blocks: `<script>`, `javascript:`, `onclick=`, `<iframe>`, etc.
- Detects: Repeated chars (>50), excessive newlines (>500)

#### `src/js/utils/rateLimiter.js`
**Purpose:** Client-side rate limiting

**Storage:** localStorage with timestamped attempts

**Methods:**
- `checkLimit(action, maxAttempts, windowMs)` - Validate action
- `resetLimit(action)` - Clear history
- `cleanup()` - Remove old data (>1 hour)

**Default Limits:**
- Note creation: 5 per minute

**Security Note:** Client-side only, can be bypassed. Consider server-side rate limiting.

---

### HTML Pages

#### `index.html`
**Purpose:** Main note creation interface

**Features:**
- Textarea with character counter (2250 max)
- Settings accordion (encryption + expiration)
- Link display with copy/WhatsApp share
- Cloudflare Turnstile widget
- Auto-save to localStorage

**Security:**
- Comprehensive CSP headers
- Script integrity from CDN sources

#### `note.html`
**Purpose:** Note viewing/decryption page

**Flow:**
1. Extract note ID from URL (`?id=xxx`)
2. Fetch from Supabase
3. Decrypt if needed
4. Display content
5. Delete on server (read_count = 1)

**Error Handling:**
- Already read
- Expired
- Not found
- Decryption failed

---

### CSS Architecture

#### `src/css/base.css`
- CSS variables (light/dark themes)
- Base resets and typography
- Container layout
- Footer with Turnstile integration
- Responsive breakpoints

#### `src/css/components.css`
- Form components (textarea, buttons)
- Link display cards
- WhatsApp share button
- Loading states
- Character counter

#### `src/css/note.css`
- Note viewing page styles
- Error/info containers
- Content display area
- Back navigation

#### `src/css/settings.css`
- Accordion animation
- Radio button custom styling
- Settings grid layout
- Mobile responsive

---

## Configuration Flow

### Development Mode
```
1. index.html loads
2. load-Env.js runs (DOMContentLoaded)
3. Fetches env.json → window.__ENV
4. src/js/conf/config.js imports
5. initializeConfig() detects no XOR_KEY (dev mode)
6. Reads from window.__ENV
7. Deletes window.__ENV (security)
8. Config ready
```

### Production Mode (GitHub Pages)
```
1. GitHub Actions triggers on push
2. src/js/conf/build-config.js runs (Node.js)
3. Reads GitHub Secrets
4. Generates unique XOR key
5. Encrypts all config values
6. Overwrites src/js/conf/config.js with production version
7. Deploys to GitHub Pages
8. Browser loads encrypted config
9. initializeConfig() detects XOR_KEY (prod mode)
10. XOR decrypts values on init
11. Config ready
```

---

## Security Best Practices

### Input Validation & Sanitization
- **Always validate on client AND server** (client validation can be bypassed)
- Use `InputSanitizer` for all user inputs
- Validate UUID format before database queries
- Check content length before encryption (10KB limit)
- Block suspicious patterns (script tags, javascript:, etc.)

### XSS Prevention
- **NEVER use `innerHTML` with user content** - Use `textContent` instead
- Implement CSP headers on all pages
- Escape HTML entities when necessary
- Validate external HTML (like settings.html) before injection

### Config Management
- Never commit `env.json` (in `.gitignore`)
- Use GitHub Secrets for production
- Rotate encryption keys regularly (redeploy changes XOR key)
- XOR obfuscation prevents casual inspection (not real encryption)

### Encryption
- Client-side only (zero-knowledge architecture)
- Strong key derivation (PBKDF2, 100,000 iterations)
- Random IVs per encryption (never reuse)
- AES-256-GCM (authenticated encryption)

### Rate Limiting
- Client-side first defense (5 notes/minute)
- Consider server-side limits via Supabase Edge Functions
- Cleanup old data periodically
- **Note:** Client-side can be bypassed by clearing localStorage

### Database Security
- Enable Row-Level Security (RLS) policies
- Use CHECK constraints for validation
- Parameterized queries only (Supabase handles this)
- UUID validation prevents injection
- Automatic cleanup via triggers + cron

### CSP Headers
- Restrict script sources (self + trusted CDNs)
- Block inline eval (except Turnstile requirement)
- Limit connect-src to known domains
- Frame ancestors for Turnstile widget only
- **Note:** `unsafe-inline` required for Cloudflare Turnstile

---

## Development Workflow

### Local Setup
1. Clone repository
2. Create `env.json` (see structure above)
3. Start local server: `python -m http.server 8080`
4. Navigate to `http://localhost:8080`

### Build for Production (Local Testing)
```bash
# Set environment variables first
export SUPABASE_URL="https://xxx.supabase.co"
export SUPABASE_KEY="eyJxxx..."
export SUPABASE_TABLE_M="notes"
export CF_TR="cloudflare_key"
export ENCRYPTION_KEY="your-key"

# Run build script
node src/js/conf/build-config.js
```

**Note:** GitHub Actions handles this automatically in CI/CD

### Deploy
- Push to `main` branch
- GitHub Actions auto-deploys to Pages

---

## Common Import Paths

**From `src/js/services/` or `src/js/actions/` to config:**
```javascript
import { config } from '../conf/config.js';
```

**From `src/js/utils/` to config:**
```javascript
import { config } from '../conf/config.js';
```

**From root HTML files (index.html, note.html):**
```html
<script type="module" src="./src/js/conf/config.js"></script>
```

**Initializing config in any module:**
```javascript
import { initializeConfig } from '../conf/config.js';

// At app startup
await initializeConfig();
```

---

## Troubleshooting

### Config not loading in dev
- Check `env.json` exists in root (same directory as index.html)
- Verify `load-Env.js` loads before `src/js/conf/config.js`
- Check browser console for CORS errors
- Ensure local server is running (not opening file:// directly)
- Check `window.__ENV` is populated before config init

### Encryption failing
- Verify `ENCRYPTION_KEY` is set
- Check browser supports Web Crypto API
- Look for HTTPS requirement (localhost OK)

### Supabase errors
- Validate `SUPABASE_URL` and `SUPABASE_KEY`
- Check table name matches
- Verify RLS policies allow anonymous inserts/reads

### Turnstile not showing
- Check `CF_TR` site key is correct
- Verify domain is whitelisted in Cloudflare
- Test with `http://localhost` (allowed by default)

---

## Future Enhancements
- [ ] Server-side rate limiting (Supabase Edge Functions)
- [ ] Password-protected notes
- [ ] File attachment support
- [ ] Multiple read counts option
- [ ] Custom expiration times
- [ ] Dark mode toggle (auto-detect only now)

---

## Dependencies

### Runtime (CDN)
- Font Awesome 6.4.0 (icons)
- Supabase JS 2.x (esm.sh)
- Cloudflare Turnstile (challenges.cloudflare.com)

### Build
- Node.js 18+ (GitHub Actions)
- No npm dependencies (vanilla JS)

---

## License & Credits
© 2025 PrivacyNote - Secure, self-destructing notes

**Developer:** Mat (1drive1hb)
**Repository:** https://github.com/1drive1hb/PrivacyNote
